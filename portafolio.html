<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Portafolio | DroguerÃ­a</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabase.js"></script>
<style>
body{font-family:system-ui;background:#f4f6f8;margin:0;padding:20px}
h1{margin-top:0}
.card{background:#fff;border-radius:14px;padding:16px;box-shadow:0 6px 20px rgba(0,0,0,.06)}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:16px}
.product{cursor:pointer}
.product img{width:100%;height:160px;object-fit:contain;background:#fafafa;border-radius:10px}
.product h3{margin:8px 0 4px}
.price{font-size:14px}
button{padding:10px;border:none;border-radius:10px;background:#2563eb;color:#fff;font-weight:600;cursor:pointer}
button.gray{background:#4b5563}
.cart-btn{position:fixed;right:20px;bottom:20px;background:#111;padding:14px 18px;border-radius:999px;font-weight:700}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center}
.modal-content{background:#fff;width:90%;max-width:900px;border-radius:14px;padding:20px;max-height:90vh;overflow:auto}
table{width:100%;border-collapse:collapse}
th,td{border-bottom:1px solid #eee;padding:8px;text-align:left;font-size:14px}
.close{float:right;cursor:pointer;font-weight:700}
label{font-size:12px;font-weight:600;display:block;margin-bottom:4px}
.total-box{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-top:12px}
.total{font-size:16px;font-weight:700;text-align:right}
</style>
</head>
<body>
<a href="index.html">â¬… Volver</a>
<h1>Portafolio de productos</h1>
<div class="grid" id="productos"></div>
<button class="cart-btn" onclick="abrirCarrito()">ðŸ›’ Carrito (<span id="cartCount">0</span>)</button>

<div class="modal" id="imgModal">
  <div class="modal-content">
    <span class="close" onclick="imgModal.style.display='none'">âœ–</span>
    <h3>Subir imagen del producto</h3>
    <p id="imgProd"></p>
    <input type="file" id="imgFile" accept="image/*"><br><br>
    <button onclick="subirImagen()">Subir imagen</button>
  </div>
</div>

<div class="modal" id="modal">
  <div class="modal-content">
    <span class="close" onclick="cerrarCarrito()">âœ–</span>
    <h2>REMISIÃ“N / COTIZACIÃ“N</h2>
    <label>Cliente</label>
    <select id="clienteSelect"></select>
    <table>
      <thead>
        <tr><th>Producto</th><th>Cant.</th><th>Precio</th><th>Total</th></tr>
      </thead>
      <tbody id="cartTable"></tbody>
    </table>
    <div class="total-box">
      <div class="total">Contado: $ <span id="tContado">0</span></div>
      <div class="total">Plazo 1: $ <span id="tP1">0</span></div>
      <div class="total">Plazo 2: $ <span id="tP2">0</span></div>
    </div>
  </div>
</div>

<script>
let carrito=[];
let imgProducto=null;
const formato=n=>Number(n).toLocaleString("es-CO");

async function cargarProductos(){
  const {data}=await sb.from("medicamentos")
    .select("*, medicamento_imagenes(url)").order("descripcion");
  productos.innerHTML=data.map(p=>{
    const img=p.medicamento_imagenes?.[0]?.url||
      "https://via.placeholder.com/300x200?text=Sin+imagen";
    return `<div class="card product" ondblclick='abrirImg(${JSON.stringify(p)})'>
      <img src="${img}">
      <h3>${p.descripcion}</h3>
      <div class="price">Contado: <b>$${formato(p.precio)}</b></div>
      <div class="price">${p.dias_plazo_1} dÃ­as: $${formato(p.precio_10_dias)}</div>
      <div class="price">${p.dias_plazo_2} dÃ­as: $${formato(p.precio_20_dias)}</div>
      <button onclick='agregar(${JSON.stringify(p)})'>Agregar</button>
    </div>`;
  }).join("");
}

function agregar(p){
  const e=carrito.find(i=>i.id===p.id);
  if(e)e.cantidad++; else carrito.push({
    id:p.id,descripcion:p.descripcion,cantidad:1,
    precios:{c:p.precio,p1:p.precio_10_dias,p2:p.precio_20_dias},
    modo:"c"
  });
  cartCount.textContent=carrito.reduce((a,b)=>a+Number(b.cantidad),0);
}

function abrirCarrito(){renderCarrito();modal.style.display="flex";}
function cerrarCarrito(){modal.style.display="none";}

function renderCarrito(){
  let tc=0,tp1=0,tp2=0;
  cartTable.innerHTML=carrito.map((p,i)=>{
    tc+=p.precios.c*p.cantidad;
    tp1+=p.precios.p1*p.cantidad;
    tp2+=p.precios.p2*p.cantidad;
    const precio=p.modo==="c"?p.precios.c:p.modo==="p1"?p.precios.p1:p.precios.p2;
    return `<tr>
      <td>${p.descripcion}</td>
      <td><input type="number" min="1" value="${p.cantidad}"
        onchange="carrito[${i}].cantidad=this.value;renderCarrito()"></td>
      <td>
        <select onchange="carrito[${i}].modo=this.value;renderCarrito()">
          <option value="c">Contado</option>
          <option value="p1">Plazo 1</option>
          <option value="p2">Plazo 2</option>
        </select>
      </td>
      <td>$${formato(precio*p.cantidad)}</td>
    </tr>`;
  }).join("");
  tContado.textContent=formato(tc);
  tP1.textContent=formato(tp1);
  tP2.textContent=formato(tp2);
}

function abrirImg(p){
  imgProducto=p;
  imgProd.textContent=p.descripcion;
  imgModal.style.display="flex";
}

async function subirImagen(){
  const file=imgFile.files[0];
  if(!file||!imgProducto)return;
  const path=`${imgProducto.codigo}/${Date.now()}_${file.name}`;
  const {error}=await sb.storage.from("productos").upload(path,file,{upsert:true});
  if(error){alert(error.message);return;}
  const {data}=sb.storage.from("productos").getPublicUrl(path);
  await sb.from("medicamento_imagenes").insert({
    medicamento_id:imgProducto.id,
    url:data.publicUrl
  });
  imgModal.style.display="none";
  imgFile.value="";
  cargarProductos();
}

async function cargarClientes(){
  const {data}=await sb.from("clientes").select("id,nombre").order("nombre");
  clienteSelect.innerHTML='<option value="">(sin seleccionar)</option>'+
    data.map(c=>`<option value="${c.id}">${c.nombre}</option>`).join("");
}

cargarProductos();
cargarClientes();
</script>
</body>
</html>

