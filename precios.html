<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Gestión de precios | Droguería</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabase.js"></script>

<!-- SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
body { font-family: system-ui; background:#f4f6f8; padding:20px; }
h1 { margin-top:0; }
.card { background:#fff; padding:20px; border-radius:12px; margin-bottom:20px; }
.grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:12px; }
input { padding:10px; }
button { padding:10px; border:none; border-radius:8px; cursor:pointer; background:#111; color:#fff; }
button.red { background:#b00020; }
button.gray { background:#555; }
table { width:100%; border-collapse:collapse; }
th,td { border-bottom:1px solid #eee; padding:8px; text-align:left; }
th { font-size:12px; color:#555; }
.muted { font-size:12px; color:#777; }

<style>
label {
  font-size: 12px;
  font-weight: 600;
  margin-bottom: 4px;
  display: block;
}
</style>
</head>
<body>

<a href="index.html">⬅ Volver</a>
<h1>Gestión de precios</h1>

<!-- CONFIGURACIÓN GLOBAL -->
<div class="card">
  <h3>Configuración global de plazos</h3>

  <div class="grid">
    <div>
      <label>Días plazo 1</label>
      <input id="gDias1" type="number" value="10">
    </div>

    <div>
      <label>% plazo 1</label>
      <input id="gPorc1" type="text" value="10%">
    </div>

    <div>
      <label>Días plazo 2</label>
      <input id="gDias2" type="number" value="20">
    </div>

    <div>
      <label>% plazo 2</label>
      <input id="gPorc2" type="text" value="20%">
    </div>
  </div>

  <br>
  <button class="gray" onclick="actualizarTodos()">Actualizar todos los precios</button>

  <p class="muted">
    Precio = Precio base × (1 + porcentaje / 100)
  </p>
</div>


<br>
<button class="gray" onclick="actualizarTodos()">Actualizar todos los precios</button>

<p class="muted">
Precio = Precio base × (1 + porcentaje / 100)
</p>
</div>

<!-- FORMULARIO -->
<div class="card">
<h3>Crear / editar medicamento</h3>

<input type="hidden" id="id">

<div class="grid">
  <input id="referencia" placeholder="Referencia">
  <input id="codigo" placeholder="Código (único)">
  <input id="descripcion" placeholder="Descripción">
  <input id="costo" type="number" placeholder="Costo">
  <input id="precio" type="number" placeholder="Precio base">

  <input id="p1" placeholder="Precio plazo 1" disabled>
  <input id="p2" placeholder="Precio plazo 2" disabled>
</div>

<br>
<button onclick="guardar()">Guardar</button>
<button class="red" onclick="eliminar()">Eliminar</button>
</div>

<!-- EXCEL -->
<div class="card">
<h3>Actualizar por Excel</h3>
<input type="file" id="excelFile" accept=".xlsx,.xls">
<br><br>
<button onclick="importExcel()">Importar / Actualizar</button>
<button onclick="downloadTemplate()">Descargar plantilla</button>
<div id="excelMsg" class="muted"></div>
</div>

<!-- LISTADO -->
<div class="card">
<h3>Listado</h3>
<table>
<thead>
<tr>
  <th>Código</th>
  <th>Descripción</th>
  <th>Base</th>
  <th>Plazo 1</th>
  <th>Plazo 2</th>
  <th></th>
</tr>
</thead>
<tbody id="lista"></tbody>
</table>
</div>

<script>
function calc(precio, porc){ return +(precio * (1 + porc/100)).toFixed(2); }

function recalcular() {
  const base = Number(precio.value||0);
  p1.value = calc(base, getPorcentaje("gPorc1"));
  p2.value = calc(base, getPorcentaje("gPorc2"));
}

precio.addEventListener("input", recalcular);
gPorc1.addEventListener("input", recalcular);
gPorc2.addEventListener("input", recalcular);

async function cargar(){
  const {data} = await sb.from("medicamentos").select("*").order("descripcion");
  lista.innerHTML = data.map(m=>`
    <tr>
      <td>${m.codigo}</td>
      <td>${m.descripcion}</td>
      <td>$${m.precio}</td>
      <td>${m.dias_plazo_1}d (${m.porc_plazo_1}%) → $${m.precio_10_dias}</td>
      <td>${m.dias_plazo_2}d (${m.porc_plazo_2}%) → $${m.precio_20_dias}</td>
      <td><button onclick='editar(${JSON.stringify(m)})'>Editar</button></td>
    </tr>`).join("");
}

function editar(m){
  id.value=m.id;
  referencia.value=m.referencia||"";
  codigo.value=m.codigo;
  descripcion.value=m.descripcion;
  costo.value=m.costo;
  precio.value=m.precio;

  gDias1.value=m.dias_plazo_1;
  gPorc1.value=m.porc_plazo_1;
  gDias2.value=m.dias_plazo_2;
  gPorc2.value=m.porc_plazo_2;

  recalcular();
}

async function guardar(){
  const base=Number(precio.value);
  const payload={
    referencia:referencia.value,
    codigo:codigo.value,
    descripcion:descripcion.value,
    costo:Number(costo.value),
    precio:base,

    dias_plazo_1:Number(gDias1.value),
    porc_plazo_1:getPorcentaje("gPorc1"),
    precio_10_dias:calc(base,getPorcentaje("gPorc1")),

    dias_plazo_2:Number(gDias2.value),
    porc_plazo_2:getPorcentaje("gPorc2"),
    precio_20_dias:calc(base,getPorcentaje("gPorc2"))
  };

  let r=id.value
    ? await sb.from("medicamentos").update(payload).eq("id",id.value)
    : await sb.from("medicamentos").insert(payload);

  if(r.error) alert(r.error.message);
  else{ limpiar(); cargar(); }
}

async function actualizarTodos(){
  if(!confirm("¿Actualizar TODOS los productos?")) return;

  const {data}=await sb.from("medicamentos").select("*");
  for(const m of data){
    const base=m.precio;
    await sb.from("medicamentos").update({
      dias_plazo_1:Number(gDias1.value),
      porc_plazo_1:getPorcentaje("gPorc1"),
      precio_10_dias:calc(base,getPorcentaje("gPorc1")),
      dias_plazo_2:Number(gDias2.value),
      porc_plazo_2:getPorcentaje("gPorc2"),
      precio_20_dias:calc(base,getPorcentaje("gPorc2"))
    }).eq("id",m.id);
  }
  alert("Precios actualizados");
  cargar();
}

function limpiar(){
  id.value=referencia.value=codigo.value=descripcion.value=costo.value=precio.value="";
  p1.value=p2.value="";
}

function downloadTemplate(){
  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.json_to_sheet([{codigo:"770123",descripcion:"Ejemplo",precio:1500}]);
  XLSX.utils.book_append_sheet(wb,ws,"medicamentos");
  XLSX.writeFile(wb,"plantilla_medicamentos.xlsx");
}

async function importExcel(){
  const file=excelFile.files[0];
  if(!file) return;
  const rows=XLSX.utils.sheet_to_json(
    XLSX.read(await file.arrayBuffer(),{type:"array"}).Sheets["medicamentos"]
  );

  for(const r of rows){
    const base=Number(r.precio||0);
    await sb.from("medicamentos").upsert({
      codigo:r.codigo,
      descripcion:r.descripcion,
      precio:base,
      dias_plazo_1:Number(gDias1.value),
      porc_plazo_1:getPorcentaje("gPorc1"),
      precio_10_dias:calc(base,getPorcentaje("gPorc1")),
      dias_plazo_2:Number(gDias2.value),
      porc_plazo_2:getPorcentaje("gPorc2"),
      precio_20_dias:calc(base,getPorcentaje("gPorc2"))
    },{onConflict:"codigo"});
  }
  excelMsg.textContent="Importación finalizada";
  cargar();
}

cargar();
function getPorcentaje(inputId) {
  const v = document.getElementById(inputId).value
    .replace('%','')
    .trim();
  return Number(v || 0);
}
</script>

</body>
</html>


